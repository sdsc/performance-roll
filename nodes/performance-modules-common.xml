<?xml version="1.0" standalone="no"?>

<kickstart>

<description>
Performance tools
</description>

<copyright>
Copyright (c) 2000 - 2011 The Regents of the University of California.
All rights reserved. Rocks(r) v5.1 www.rocksclusters.org
</copyright>

<changelog>
</changelog>

<post>

# Remove /etc/profile.d files in favor of loadable modules when available

if test `grep -c /opt/modulefiles/applications /etc/profile.d/modules.csh` = 0; then
  echo 'setenv MODULEPATH /opt/modulefiles/applications:$MODULEPATH' >> \
       /etc/profile.d/modules.csh
  echo 'if ( -s ${HOME}/.modules ) then' >> /etc/profile.d/modules.csh
  echo 'source ${HOME}/.modules' >> /etc/profile.d/modules.csh
  echo 'endif' >> /etc/profile.d/modules.csh

fi
if test `grep -c /opt/modulefiles/applications /etc/profile.d/modules.sh` = 0; then
  echo 'export MODULEPATH=/opt/modulefiles/applications:$MODULEPATH' >> \
       /etc/profile.d/modules.sh
  echo 'if test -f ${HOME}/.modules; then' >> /etc/profile.d/modules.sh
  echo '. ${HOME}/.modules' >> /etc/profile.d/modules.sh
  echo 'fi' >> /etc/profile.d/modules.sh
fi


<!-- PDT  -->

  for COMPILER in `ls /opt/pdt`; do

    /bin/mkdir -m 0755 -p /opt/modulefiles/applications/.$COMPILER/pdt

    cat &gt; /opt/modulefiles/applications/.$COMPILER/pdt/3.15 &lt;&lt; END
#%Module1.0
prepend-path PATH /opt/pdt/$COMPILER/x86_64/bin
prepend-path LD_LIBRARY_PATH /opt/pdt/$COMPILER/x86_64/lib
END
    chmod 0644 /opt/modulefiles/applications/.$COMPILER/pdt/3.15

   cat &gt; /opt/modulefiles/applications/.$COMPILER/pdt/.version.3.15 &lt;&lt; END
#%Module1.0
set ModulesVersion "3.15"
END
    chmod 0644 /opt/modulefiles/applications/.$COMPILER/pdt/.version.3.15

/bin/ln -s /opt/modulefiles/applications/.$COMPILER/pdt/.version.3.15 \
      /opt/modulefiles/applications/.$COMPILER/pdt/.version

done

<!-- MXML -->

  for COMPILER in `ls /opt/mxml`; do
    /bin/mkdir -m 0755 -p /opt/modulefiles/applications/.$COMPILER/mxml

  cat &gt; /opt/modulefiles/applications/.$COMPILER/mxml/2.7 &lt;&lt; END
#%Module1.0
prepend-path PATH /opt/mxml/$COMPILER/bin
prepend-path LD_LIBRARY_PATH /opt/mxml/.$COMPILER/lib
END
  chmod 0644  /opt/modulefiles/applications/.$COMPILER/mxml/2.7

   cat &gt; /opt/modulefiles/applications/.$COMPILER/mxml/.version.2.7 &lt;&lt; END
#%Module1.0
set ModulesVersion "2.7"
END
   chmod 0644  /opt/modulefiles/applications/.$COMPILER/mxml/.version.2.7

/bin/ln -s /opt/modulefiles/applications/.$COMPILER/mxml/.version.2.7 \
               /opt/modulefiles/applications/.$COMPILER/mxml/.version
done

<!-- PAPI -->
  for COMPILER in `ls /opt/papi`; do
    /bin/mkdir -m 0755 -p /opt/modulefiles/applications/.$COMPILER/papi

  cat &gt; /opt/modulefiles/applications/.$COMPILER/papi/4.2.1  &lt;&lt; END
#%Module1.0
prepend-path PATH /opt/papi/$COMPILER/bin
prepend-path LD_LIBRARY_PATH /opt/papi/$COMPILER/lib
END
  chmod 0644  /opt/modulefiles/applications/.$COMPILER/papi/4.2.1

  cat &gt; /opt/modulefiles/applications/.$COMPILER/papi/.version.4.2.1 &lt;&lt; END
#%Module1.0
set ModulesVersion "4.2.1"
END
  chmod 0644 /opt/modulefiles/applications/.$COMPILER/papi/.version.4.2.1

/bin/ln -s /opt/modulefiles/applications/.$COMPILER/papi/.version.4.2.1\
               /opt/modulefiles/applications/.$COMPILER/papi/.version
done

<!-- VALGRIND -->
/bin/mkdir -m 0755 -p /opt/modulefiles/applications/valgrind

  cat &gt; /opt/modulefiles/applications/valgrind/3.7.0  &lt;&lt; END
#%Module1.0
prepend-path PATH /opt/valgrind/bin
END
  chmod 0644  /opt/modulefiles/applications/valgrind/3.7.0

  cat &gt; /opt/modulefiles/applications/valgrind/.version.3.7.0 &lt;&lt; END
#%Module1.0
set ModulesVersion "4.2.1"
END
  chmod 0644 /opt/modulefiles/applications/.$COMPILER/valgrind/.version.3.7.0

/bin/ln -s /opt/modulefiles/applications/.$COMPILER/valgrind/.version.3.7.0 \
               /opt/modulefiles/applications/.$COMPILER/valgrind/.version
<!-- TAU -->

  for COMPILER in `ls /opt/tau`; do
    /bin/mkdir -m 0755 -p /opt/modulefiles/applications/.$COMPILER/tau
   cat &gt; /opt/modulefiles/applications/.$COMPILER/tau/2.21.3 &lt;&lt; END
#%Module1.0
if { ! [info exists env(MPIHOME)] } {
  puts stderr "Need to load an mpi module first"
  exit
} elseif { [string match "*mpich2*" \$env(MPIHOME)] } {
  set mpiType mpich2
} elseif { [string match "*mpich*" \$env(MPIHOME)] } {
  set mpiType mpich
} elseif { [string match "*mvapich2*" \$env(MPIHOME)] } {
  set mpiType mvapich2
} elseif { [string match "*openmpi*" \$env(MPIHOME)] } {
  set mpiType openmpi
} else {
  puts stderr "Unknown mpi \$env(MPIHOME)"
  exit
}
prepend-path PATH /opt/tau/$COMPILER/\$mpiType/x86_64/bin
prepend-path LD_LIBRARY_PATH /opt/tau/$COMPILER/\$mpiType/x86_64/lib
prepend-path LD_LIBRARY_PATH /opt/papi/$COMPILER/lib
END

   chmod 0644 /opt/modulefiles/applications/.$COMPILER/tau/2.21.3

cat &gt; /opt/modulefiles/applications/.$COMPILER/tau/.version.2.21.3 &lt;&lt; END
#%Module1.0
set ModulesVersion "2.21.3"
END
   chmod 0664 /opt/modulefiles/applications/.$COMPILER/tau/.version.2.21.3

  /bin/ln -s /opt/modulefiles/applications/.$COMPILER/tau/.version.2.21.3 \
             /opt/modulefiles/applications/.$COMPILER/tau/.version
done

<!-- IPM -->


  for COMPILER in `ls /opt/ipm`; do
    /bin/mkdir -m 0755 -p /opt/modulefiles/applications/.$COMPILER/ipm
cat &gt; /opt/modulefiles/applications/.$COMPILER/ipm/2.0.0 &lt;&lt; END
#%Module1.0
if { ! [info exists env(MPIHOME)] } {
  puts stderr "Need to load an mpi module first"
  exit
} elseif { [string match "*mpich2*" \$env(MPIHOME)] } {
  set mpiType mpich2
} elseif { [string match "*mpich*" \$env(MPIHOME)] } {
  set mpiType mpich
} elseif { [string match "*mvapich2*" \$env(MPIHOME)] } {
  set mpiType mvapich2
} elseif { [string match "*openmpi*" \$env(MPIHOME)] } {
  set mpiType openmpi
} else {
  puts stderr "Unknown mpi \$env(MPIHOME)"
  exit
}
prepend-path PATH /opt/ipm/$COMPILER/\$mpiType/bin
setenv IPM_BASE /opt/ipm/$COMPILER/\$mpiType
prepend-path LD_LIBRARY_PATH /opt/ipm/$COMPILER/\$mpiType/lib
prepend-path LD_LIBRARY_PATH /opt/mxml/$COMPILER/lib
prepend-path LD_LIBRARY_PATH /opt/papi/$COMPILER/lib
END

chmod 0644  /opt/modulefiles/applications/.$COMPILER/ipm/2.0.0

cat &gt; /opt/modulefiles/applications/.$COMPILER/ipm/.version.2.0.0 &lt;&lt; END
#%Module1.0
set ModulesVersion "2.0.0"
END
chmod 0644 /opt/modulefiles/applications/.$COMPILER/ipm/.version.2.0.0
/bin/ln -s /opt/modulefiles/applications/.$COMPILER/ipm/.version.2.0.0 \
               /opt/modulefiles/applications/.$COMPILER/ipm/.version

done
</post>

</kickstart>
